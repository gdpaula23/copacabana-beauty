<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Checkout | Copacabana Beauty</title>

<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">

<style>
:root{
  --olive-900:#2F3A22;
  --olive-800:#3F4D2F;
  --olive-700:#566643;

  --beige:#F4EAD6;
  --beige-80: rgba(244,234,214,.80);
  --beige-40: rgba(244,234,214,.40);
  --beige-22: rgba(244,234,214,.22);
  --beige-14: rgba(244,234,214,.14);
  --beige-10: rgba(244,234,214,.10);

  --surface:#F5EFE6;
  --surface-2:#FBF9F4;
  --stroke:#E2D9C7;

  --shadow: 0 40px 90px rgba(0,0,0,.30);
  --radius-xl: 24px;
  --max: 980px;
}

*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}

body{
  font-family:'Montserrat',sans-serif;
  color:var(--beige);
  background:
    radial-gradient(circle at 12% 18%, rgba(244,234,214,.10), transparent 65%),
    radial-gradient(circle at 78% 12%, rgba(244,234,214,.08), transparent 68%),
    radial-gradient(circle at 55% 78%, rgba(244,234,214,.07), transparent 72%),
    linear-gradient(180deg,#4B5A3A 0%, #3F4D2F 45%, #2F3A22 100%);
  overflow-x:hidden;
}

.marble-overlay{
  position:fixed;
  inset:-12%;
  z-index:0;
  pointer-events:none;
  background-image:url("marble.png");
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
  opacity:.11;
  filter: blur(1.2px) saturate(.85) contrast(.95);
  mix-blend-mode: soft-light;
  transform: scale(1.12);
}
body > *:not(.marble-overlay){position:relative; z-index:1;}

nav{
  position:fixed;
  top:0; left:0; width:100%;
  padding:18px 40px;
  z-index:50;
  display:flex;
  justify-content:flex-end;
  gap:22px;
  background:transparent;
}
nav a{
  color:rgba(244,234,214,.92);
  text-decoration:none;
  font-size:12px;
  letter-spacing:2px;
  opacity:.95;
}
.nav-cta{
  padding:10px 14px;
  border:1px solid rgba(244,234,214,.28);
  border-radius:999px;
  background:rgba(244,234,214,.10);
}

.wrap{max-width:var(--max); margin:0 auto; padding:0 20px;}
.section{padding:120px 0 110px;}

h1{
  font-family:'Cormorant Garamond',serif;
  font-size:48px;
  text-align:center;
  margin-bottom:12px;
  text-shadow:0 18px 40px rgba(0,0,0,.20);
}
.sub{
  text-align:center;
  max-width:780px;
  margin:0 auto 44px;
  opacity:.88;
  line-height:1.9;
  font-size:15px;
}
.title-line{
  width:min(520px, 88%);
  height:1px;
  margin:22px auto 0;
  background:linear-gradient(to right, transparent, rgba(244,234,214,.50), transparent);
}

.layout{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:18px;
  margin-top:44px;
}

.panel{
  background:
    linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02)),
    rgba(244,234,214,.10);
  border:1px solid rgba(244,234,214,.22);
  border-radius:var(--radius-xl);
  box-shadow:0 24px 60px rgba(0,0,0,.18);
  padding:22px;
}

.summary-card{
  background:var(--surface-2);
  border:1px solid var(--stroke);
  border-radius:18px;
  padding:18px 16px;
  color:var(--olive-900);
  box-shadow: 0 14px 34px rgba(0,0,0,.10);
}

.summary-row{
  display:flex;
  justify-content:space-between;
  gap:12px;
  padding:10px 0;
  font-size:14px;
  color:var(--olive-900);
}
.summary-row + .summary-row{ border-top:1px solid rgba(47,58,34,.10); }
.summary-row.total{
  border-top:1px solid rgba(47,58,34,.18);
  margin-top:10px;
  padding-top:14px;
  font-size:16px;
  font-weight:600;
}

.items-mini{
  display:grid;
  gap:10px;
  margin-top:12px;
}
.mini{
  background:var(--surface);
  border:1px solid var(--stroke);
  border-radius:16px;
  padding:12px 12px;
  color:var(--olive-900);
  box-shadow: 0 10px 26px rgba(0,0,0,.08);
}
.mini .t{
  font-family:'Cormorant Garamond',serif;
  font-size:20px;
  line-height:1.05;
}
.mini .m{
  margin-top:6px;
  font-size:12px;
  letter-spacing:2px;
  text-transform:uppercase;
  opacity:.70;
  color:rgba(47,58,34,.75);
}
.mini .b{
  margin-top:6px;
  font-size:13px;
  opacity:.88;
  color:rgba(47,58,34,.85);
}

.form{ display:grid; gap:12px; }
.label{
  font-size:12px;
  letter-spacing:2px;
  text-transform:uppercase;
  opacity:.85;
}
.input{
  width:100%;
  padding:13px 12px;
  border-radius:14px;
  border:1px solid rgba(244,234,214,.22);
  outline:none;
  background:rgba(0,0,0,.10);
  color:var(--beige);
}
.actions{
  display:grid;
  gap:10px;
  margin-top:6px;
}
.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:14px 18px;
  border-radius:999px;
  text-decoration:none;
  font-size:12px;
  letter-spacing:2px;
  text-transform:uppercase;
  border:none;
  cursor:pointer;
}
.btn-primary{
  background:var(--beige);
  color:var(--olive-800);
  border:1px solid rgba(244,234,214,.75);
}
.btn-ghost{
  background:rgba(244,234,214,.10);
  border:1px solid rgba(244,234,214,.28);
  color:rgba(244,234,214,.92);
}
.note{
  margin-top:12px;
  font-size:12px;
  opacity:.78;
  line-height:1.8;
  text-align:center;
  color:rgba(244,234,214,.78);
}

.badge{
  display:inline-block;
  padding:10px 12px;
  border-radius:18px;
  border:1px solid rgba(244,234,214,.22);
  background:rgba(0,0,0,.10);
  color:rgba(244,234,214,.88);
  font-size:12px;
  line-height:1.6;
}

/* FAB */
.cart-fab{
  position:fixed !important;
  right:18px !important;
  bottom:18px !important;
  z-index:9999 !important;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(0,0,0,.18);
  backdrop-filter:blur(10px);
  padding:12px 14px;
  border-radius:999px;
  color:rgba(244,234,214,.92);
  font-size:12px;
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  gap:8px;
  white-space:nowrap;
}
.cart-fab span{
  padding:2px 8px;
  border-radius:999px;
  background:rgba(244,234,214,.16);
}

/* Mobile UX */
@media(max-width:1020px){
  nav{ padding:16px 16px; }
  .layout{ grid-template-columns:1fr; }
  .btn{ width:100%; }
}
</style>
</head>

<body>
<div class="marble-overlay" id="marbleOverlay"></div>

<nav id="nav">
  <a href="home.html">HOME</a>
  <a href="services2.html">SERVICES</a>
  <a href="cart.html" class="nav-cta">BASKET</a>
</nav>

<section class="section">
  <div class="wrap">
    <h1>Checkout</h1>
    <p class="sub">Pay a £20 deposit to secure your appointment. The remaining balance is paid on the day of your service.</p>
    <div class="title-line"></div>

    <div class="layout">
      <!-- LEFT -->
      <div class="panel">
        <div class="form">
          <div>
            <div class="label">Full name</div>
            <input class="input" id="customerName" placeholder="Your name" autocomplete="name" />
          </div>
          <div>
            <div class="label">Email</div>
            <input class="input" id="customerEmail" placeholder="you@email.com" autocomplete="email" />
          </div>

          <div class="badge" id="statusBox" style="display:none;"></div>

          <div class="actions">
            <button class="btn btn-ghost" id="btnHealthForm" type="button">
              HEALTH &amp; MEDICAL FORM (REQUIRED)
            </button>

            <div class="badge" style="text-align:center;">
              All clients must complete the Health &amp; Medical Form before their appointment.
            </div>

            <button class="btn btn-primary" id="payBtn" type="button">Pay £20 deposit</button>
            <a class="btn btn-ghost" href="cart.html">Back to basket</a>
          </div>

          <div class="note">
            You’ll be redirected to secure Stripe Checkout. After payment, you’ll return to our website automatically.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="summary-card">
          <div class="summary-row">
            <span>Subtotal</span>
            <span id="subtotal">£0</span>
          </div>
          <div class="summary-row">
            <span>Deposit today</span>
            <span id="depositToday">£0</span>
          </div>
          <div class="summary-row">
            <span>Remaining on appointment day</span>
            <span id="remainingDay">£0</span>
          </div>
          <div class="summary-row total">
            <span>Total (full service value)</span>
            <span id="total">£0</span>
          </div>

          <div class="items-mini" id="miniItems"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<a class="cart-fab" href="cart.html">
  BASKET <span id="cartCount">0</span>
</a>

<script>
const BOOKING_KEY = "cb_booking_v1";
const CART_KEY = "cb_cart_v1";
const DEPOSIT = 20;
const PAYMENT_PENDING_KEY = "cb_payment_pending_v1";

function loadJSONFrom(storage, key){
  try { return JSON.parse(storage.getItem(key) || "null"); }
  catch { return null; }
}
function moneyGBP(v){
  const n = Number(v || 0);
  return "£" + n.toFixed(0);
}

// ✅ booking ONLY sessionStorage
function getBooking(){ return loadJSONFrom(sessionStorage, BOOKING_KEY); }

// ✅ cart localStorage
function getCart(){ return loadJSONFrom(localStorage, CART_KEY); }

function getServiceFromCart(){
  const cart = getCart();
  if (!Array.isArray(cart) || !cart.length) return null;
  const item = cart[0];
  const name = item?.name || item?.title || "Service";
  const price = Number(item?.price || item?.value || 150);
  const qty = Number(item?.qty || 1);
  return { name, price, qty, subtotal: price * qty };
}

// ✅ Auto-clean after Stripe return
(function handleReturn(){
  const params = new URLSearchParams(location.search);
  const success = params.get("success") === "1";
  const canceled = params.get("canceled") === "1";
  const sessionId = params.get("session_id");
  const pending = sessionStorage.getItem(PAYMENT_PENDING_KEY) === "1";

  if (canceled){
    sessionStorage.removeItem(PAYMENT_PENDING_KEY);
  }

  // success OR (has session_id and was pending)
  if (success || (sessionId && pending)){
    sessionStorage.removeItem(PAYMENT_PENDING_KEY);

    // clear booking + cart
    sessionStorage.removeItem(BOOKING_KEY);
    localStorage.removeItem(BOOKING_KEY); // legado
    localStorage.removeItem(CART_KEY);

    // clean URL (no params)
    window.history.replaceState({}, document.title, window.location.pathname);

    // show message
    const box = document.getElementById("statusBox");
    box.style.display = "block";
    box.innerHTML = "✅ Payment received! Your booking is confirmed. Thank you!";
  }
})();

// ✅ Lock checkout: must have cart + booking
(function requireData(){
  const cart = getCart();
  if (!Array.isArray(cart) || !cart.length){
    window.location.replace("cart.html");
    throw new Error("No cart found — redirecting");
  }

  const booking = getBooking();
  if (!booking?.staffKey || !booking?.startISO || !booking?.endISO){
    window.location.replace("booking.html");
    throw new Error("No booking found — redirecting");
  }
})();

const el = {
  customerName: document.getElementById("customerName"),
  customerEmail: document.getElementById("customerEmail"),
  statusBox: document.getElementById("statusBox"),
  payBtn: document.getElementById("payBtn"),

  subtotal: document.getElementById("subtotal"),
  depositToday: document.getElementById("depositToday"),
  remainingDay: document.getElementById("remainingDay"),
  total: document.getElementById("total"),
  miniItems: document.getElementById("miniItems"),
  cartCount: document.getElementById("cartCount"),
};

function setStatus(html){
  el.statusBox.style.display = "block";
  el.statusBox.innerHTML = html;
}

function setLoading(isLoading){
  el.payBtn.disabled = isLoading;
  el.payBtn.style.opacity = isLoading ? "0.7" : "1";
}

(function initSummary(){
  const cart = getCart();
  el.cartCount.textContent = Array.isArray(cart) ? String(cart.length) : "0";

  const service = getServiceFromCart() || { name: "Head Spa & Facial", subtotal: 150 };
  const total = Number(service.subtotal || 150);
  const remaining = Math.max(0, total - DEPOSIT);

  el.subtotal.textContent = moneyGBP(total);
  el.depositToday.textContent = moneyGBP(DEPOSIT);
  el.remainingDay.textContent = moneyGBP(remaining);
  el.total.textContent = moneyGBP(total);

  el.miniItems.innerHTML = `
    <div class="mini">
      <div class="t">${service.name}</div>
      <div class="m">Service selected</div>
      <div class="b">Value: <b>${moneyGBP(total)}</b></div>
    </div>
  `;

  const booking = getBooking();
  const when = (booking.date ? booking.date : "") + (booking.label ? (" · " + booking.label) : "");
  el.miniItems.innerHTML += `
    <div class="mini">
      <div class="t">Appointment</div>
      <div class="m">${booking.staffName || booking.staffKey || "Staff"}</div>
      <div class="b">
        ${when}<br>
        <span style="opacity:.8;">Duration: ${booking.durationMin || 60} min</span>
      </div>

      <div style="margin-top:12px;">
        <button id="changeApptBtn" type="button"
          style="
            width:100%;
            padding:12px 14px;
            border-radius:999px;
            border:1px solid rgba(47,58,34,.18);
            background:rgba(47,58,34,.06);
            color:rgba(47,58,34,.85);
            font-size:12px;
            letter-spacing:2px;
            text-transform:uppercase;
            cursor:pointer;
          ">
          Change therapist / time
        </button>
      </div>
    </div>
  `;
})();

// ✅ Change appointment
document.addEventListener("click", (e) => {
  const t = e.target;
  if (!(t instanceof Element)) return;
  if (t.id !== "changeApptBtn") return;

  sessionStorage.removeItem(BOOKING_KEY);
  localStorage.removeItem(BOOKING_KEY); // legado
  window.location.href = "booking.html?reset=1";
});

el.payBtn.addEventListener("click", async (e) => {
  e.preventDefault();

  const booking = getBooking();
  const customerName = (el.customerName.value || "").trim();
  const customerEmail = (el.customerEmail.value || "").trim();

  if (!booking?.staffKey || !booking?.startISO || !booking?.endISO){
    setStatus("⚠️ Missing booking info. Please go back and select a time again.");
    return;
  }
  if (!customerEmail){
    setStatus("⚠️ Please enter your email.");
    return;
  }

  try{
    setLoading(true);
    setStatus("Opening secure Stripe Checkout…");

    // mark payment pending (used for auto-clean on return)
    sessionStorage.setItem(PAYMENT_PENDING_KEY, "1");

    const resp = await fetch("/api/create-checkout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ booking, customerName, customerEmail })
    });

    const data = await resp.json();
    if (!resp.ok || !data?.url){
      sessionStorage.removeItem(PAYMENT_PENDING_KEY);
      setLoading(false);
      setStatus("⚠️ Could not start payment. Please try again.");
      return;
    }

    window.location.href = data.url;
  }catch(err){
    console.error(err);
    sessionStorage.removeItem(PAYMENT_PENDING_KEY);
    setLoading(false);
    setStatus(`⚠️ Could not start payment. Please try again. <br><br>
<a href="booking.html" style="color:#F4EAD6;text-decoration:underline;">Go to booking</a>`);
  }
});
</script>

<script>
  (function(){
    const btn = document.getElementById("btnHealthForm");
    if (!btn) return;

    const JOTFORM_URL = "https://form.jotform.com/260342392791055";

    btn.addEventListener("click", () => {
      window.open(JOTFORM_URL, "_blank", "noopener");
    });

    const params = new URLSearchParams(window.location.search);
    if (params.get("healthForm") === "submitted") {
      window.history.replaceState({}, document.title, window.location.pathname);
      alert("✅ Form received!\n\nYour Health & Medical Form has been submitted and will be reviewed. You may proceed with the deposit payment. If anything requires clarification, we will contact you.");
    }
  })();
</script>

</body>
</html>
