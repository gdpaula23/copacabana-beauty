<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Booking | Copacabana Beauty</title>

<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">

<style>
:root{
  --verde:#3E4A2B;
  --bege:#F4EAD6;

  --panel: rgba(244,234,214,.10);
  --border: rgba(244,234,214,.18);
  --border-strong: rgba(244,234,214,.55);

  --dark: rgba(0,0,0,.35);
  --glass: rgba(0,0,0,.18);
}

*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:'Montserrat',sans-serif;
  color:var(--bege);
}

.page-bg{
  min-height:100vh;
  display:flex;
  flex-direction:column;
  background:
    radial-gradient(circle 320px at 50% 18%, rgba(244,234,214,.09), transparent 70%),
    radial-gradient(circle 260px at 20% 30%, rgba(244,234,214,.06), transparent 70%),
    radial-gradient(circle 260px at 85% 55%, rgba(244,234,214,.05), transparent 70%),
    radial-gradient(circle at 20% 20%, rgba(244,234,214,.12), transparent 80%),
    linear-gradient(180deg,#3E4A2B,#3E4A2B);
}

.main{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.hero{
  padding:52px 20px 18px;
  text-align:center;
}
.hero img{max-width:240px;}

.card{
  width:100%;
  max-width:920px;
  margin:0 18px 80px;
  padding:26px;

  background:
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)),
    var(--panel);

  backdrop-filter: blur(16px);
  border-radius:22px;
  border:1px solid rgba(255,255,255,.15);
  box-shadow:0 40px 80px rgba(0,0,0,.35);
}

.header{
  text-align:center;
}
.header h1{
  font-family:'Cormorant Garamond',serif;
  font-size:38px;
  margin-bottom:8px;
}
.subtitle{
  opacity:.85;
  font-size:14px;
  line-height:1.6;
}
#tzLine{opacity:.75; display:block; margin-top:4px;}

.divider{
  height:1px;
  background:linear-gradient(to right, transparent, rgba(244,234,214,.85), transparent);
  margin:16px 0 18px;
}

.grid{
  display:grid;
  grid-template-columns: 1fr 1.45fr;
  gap:18px;
}

.block{
  background:var(--glass);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
}

.label{
  font-size:12px;
  letter-spacing:2px;
  text-transform:uppercase;
  opacity:.85;
  margin-bottom:12px;
}

/* STAFF CARDS */
.staff{
  display:grid;
  gap:10px;
}

.staff-btn{
  display:flex;
  align-items:center;
  gap:12px;
  width:100%;
  border:none;
  cursor:pointer;
  padding:12px;
  border-radius:16px;
  background:rgba(0,0,0,.20);
  border:1px solid rgba(244,234,214,.18);
  color:var(--bege);
  transition:.18s ease;
  text-align:left;
}

.staff-btn:hover{transform:translateY(-1px); background:rgba(0,0,0,.26)}
.staff-btn.active{
  background:rgba(244,234,214,.12);
  border-color:rgba(244,234,214,.60);
}

.staff-btn img{
  width:46px;height:46px;
  border-radius:50%;
  object-fit:cover;
  border:1px solid rgba(244,234,214,.35);
  background:rgba(0,0,0,.12);
  flex:0 0 auto;
}

.staff-name{font-weight:500;font-size:14px}
.staff-role{font-size:12px;opacity:.75;margin-top:2px}

.meta{
  margin-top:12px;
  font-size:13px;
  opacity:.9;
  line-height:1.6;
}

/* DATE PILLS */
.date-strip{
  display:flex;
  gap:10px;
  overflow:auto;
  padding-bottom:6px;
  scrollbar-width: thin;
}
.date-pill{
  flex:0 0 auto;
  border:1px solid rgba(244,234,214,.20);
  background:rgba(0,0,0,.20);
  color:var(--bege);
  border-radius:999px;
  padding:10px 12px;
  cursor:pointer;
  transition:.18s ease;
  min-width:150px;
  text-align:left;
}
.date-pill:hover{transform:translateY(-1px); background:rgba(0,0,0,.26)}
.date-pill.active{
  background:rgba(244,234,214,.12);
  border-color:rgba(244,234,214,.65);
}
.date-pill .top{
  font-size:12px;
  opacity:.85;
}
.date-pill .bottom{
  margin-top:2px;
  font-size:13px;
  font-weight:500;
}

/* SLOTS */
.slots{
  margin-top:14px;
  display:grid;
  grid-template-columns: repeat(4, minmax(90px, 1fr));
  gap:10px;
}

.slot{
  border:1px solid rgba(244,234,214,.20);
  background:rgba(0,0,0,.20);
  color:var(--bege);
  border-radius:14px;
  padding:10px 8px;
  cursor:pointer;
  transition:.18s ease;
  font-size:13px;
  text-align:center;
}

.slot:hover{transform:translateY(-1px); background:rgba(0,0,0,.26)}
.slot.active{
  background:rgba(244,234,214,.12);
  border-color:rgba(244,234,214,.65);
}

.msg{
  margin-top:12px;
  font-size:13px;
  opacity:.9;
  line-height:1.6;
}
.msg.error{color:#ffd3d3; opacity:1;}
.msg.ok{color:#d9ffd9;}

.actions{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  margin-top:18px;
}

.btn{
  border:none;
  border-radius:999px;
  padding:12px 18px;
  cursor:pointer;
  font-size:12px;
  letter-spacing:2px;
  text-transform:uppercase;
  transition:.18s ease;
}

.btn-ghost{
  background:transparent;
  color:var(--bege);
  border:1px solid rgba(244,234,214,.35);
}
.btn-ghost:hover{background:rgba(244,234,214,.10)}

.btn-primary{
  background:var(--bege);
  color:var(--verde);
}
.btn-primary:hover{transform:translateY(-1px)}
.btn[disabled]{opacity:.45;cursor:not-allowed;transform:none}

.footer{
  padding:40px 20px;
  text-align:center;
  font-size:12px;
  opacity:.6;
}

@media(max-width:950px){
  .grid{grid-template-columns:1fr}
  .slots{grid-template-columns: repeat(3, minmax(90px, 1fr));}
}
@media(max-width:420px){
  .slots{grid-template-columns: repeat(2, minmax(90px, 1fr));}
  .hero img{max-width:210px}
  .date-pill{min-width:140px;}
}
</style>
</head>

<body>
<div class="page-bg">
  <main class="main">

    <section class="hero">
      <img src="eu1.png" alt="Copacabana Beauty">
    </section>

    <section class="card">

      <div class="header">
        <h1>Booking</h1>
        <div class="subtitle">
          Choose staff, then pick a date and time.
          <span id="tzLine"></span>
        </div>
      </div>

      <div class="divider"></div>

      <div class="grid">

        <!-- STAFF -->
        <div class="block">
          <div class="label">Select staff</div>

          <div class="staff">
            <button class="staff-btn active" type="button" data-staff="ana">
              <img src="ana.jpg" alt="Ana Paula">
              <div>
                <div class="staff-name">Ana Paula</div>
                <div class="staff-role">Therapist</div>
              </div>
            </button>

            <button class="staff-btn" type="button" data-staff="glenda">
              <img src="glenda.jpg" alt="Glenda Garcia">
              <div>
                <div class="staff-name">Glenda Garcia</div>
                <div class="staff-role">Therapist</div>
              </div>
            </button>
          </div>

          <div class="meta">
            Duration: <b>60 min</b> · Working hours: <b>09:00–18:00</b><br>
            <span style="opacity:.8;">Pick a date with available slots.</span>
          </div>
        </div>

        <!-- DATE + TIMES -->
        <div class="block">
          <div class="label">Select date</div>

          <div id="dateStrip" class="date-strip" aria-label="Available dates"></div>

          <div id="loading" class="msg">Loading availability...</div>
          <div id="message" class="msg" style="display:none;"></div>

          <div id="slots" class="slots" style="display:none;"></div>

          <div class="actions">
            <button class="btn btn-ghost" id="reloadBtn" type="button">Reload</button>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn btn-ghost" id="backBtn" type="button">Back</button>
              <button class="btn btn-primary" id="continueBtn" type="button" disabled>Continue</button>
            </div>
          </div>

          <div class="msg" id="debug" style="opacity:.55; font-size:11px; margin-top:12px;"></div>
        </div>

      </div>
    </section>
  </main>

  <footer class="footer">© 2026 Copacabana Beauty · Booking</footer>
</div>

<script>
const BOOKING_KEY = "cb_booking_v1";

const state = {
  staff: "ana",
  data: null,
  date: null,
  slot: null
};

const dateStrip = document.getElementById("dateStrip");
const slotsEl = document.getElementById("slots");
const loadingEl = document.getElementById("loading");
const msgEl = document.getElementById("message");
const debugEl = document.getElementById("debug");
const continueBtn = document.getElementById("continueBtn");
const tzLine = document.getElementById("tzLine");

function showMsg(text, type){
  msgEl.style.display = "block";
  msgEl.className = "msg " + (type || "");
  msgEl.innerHTML = text;
}
function hideMsg(){
  msgEl.style.display = "none";
  msgEl.innerHTML = "";
  msgEl.className = "msg";
}

function fmtDateLong(isoDate){
  // isoDate: "2026-01-30"
  const d = new Date(isoDate + "T00:00:00");
  // Evitar “Invalid Date” em alguns browsers: iso + T00 ok.
  return d.toLocaleDateString("en-GB", { weekday:"short", day:"2-digit", month:"short" }); // Fri, 30 Jan
}
function fmtDateTop(isoDate){
  const d = new Date(isoDate + "T00:00:00");
  return d.toLocaleDateString("en-GB", { month:"long", year:"numeric" }); // January 2026
}

function getDaysForStaff(){
  const days = state.data?.days || [];
  // Só datas que têm pelo menos 1 slot dessa staff
  return days.filter(d => (d[state.staff] || []).length > 0);
}

function setStaff(staff){
  state.staff = staff;
  state.slot = null;
  continueBtn.disabled = true;

  document.querySelectorAll(".staff-btn").forEach(b => b.classList.remove("active"));
  document.querySelector(`.staff-btn[data-staff="${staff}"]`)?.classList.add("active");

  // Re-render: datas e horários, sempre escolhendo a primeira data válida
  renderDatesForStaff(true);
}

function renderDatesForStaff(forcePickFirst){
  hideMsg();
  dateStrip.innerHTML = "";
  slotsEl.style.display = "none";
  slotsEl.innerHTML = "";
  state.slot = null;
  continueBtn.disabled = true;

  const availableDays = getDaysForStaff();

  if (!availableDays.length){
    loadingEl.style.display = "none";
    showMsg("No available dates for this staff in the next days. Try <b>Reload</b> or choose the other staff.", "");
    debugEl.textContent = "Debug: availableDays=0 for staff=" + state.staff;
    return;
  }

  // Se a data atual não existe mais, escolhe a primeira
  if (forcePickFirst || !state.date || !availableDays.some(d => d.date === state.date)){
    state.date = availableDays[0].date;
  }

  // Construir pills
  availableDays.forEach(d => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "date-pill" + (d.date === state.date ? " active" : "");
    btn.dataset.date = d.date;

    const top = document.createElement("div");
    top.className = "top";
    top.textContent = fmtDateTop(d.date);

    const bottom = document.createElement("div");
    bottom.className = "bottom";
    bottom.textContent = fmtDateLong(d.date);

    btn.appendChild(top);
    btn.appendChild(bottom);

    btn.addEventListener("click", () => {
      state.date = d.date;
      document.querySelectorAll(".date-pill").forEach(x => x.classList.remove("active"));
      btn.classList.add("active");
      renderSlots();
    });

    dateStrip.appendChild(btn);
  });

  renderSlots();
}

function renderSlots(){
  hideMsg();
  slotsEl.innerHTML = "";
  state.slot = null;
  continueBtn.disabled = true;

  const days = state.data?.days || [];
  const dayObj = days.find(d => d.date === state.date);

  loadingEl.style.display = "none";
  slotsEl.style.display = "grid";

  if (!dayObj){
    showMsg("Select a date to see available times.", "");
    slotsEl.style.display = "none";
    debugEl.textContent = "Debug: dayObj not found for date=" + state.date;
    return;
  }

  const list = dayObj[state.staff] || [];

  if (!list.length){
    showMsg("No available times for this date. Try another day.", "");
    debugEl.textContent = "Debug: slots=0 for staff=" + state.staff + " date=" + state.date;
    return;
  }

  list.forEach(slot => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "slot";
    b.textContent = slot.label;
    b.dataset.start = slot.startISO;

    b.addEventListener("click", () => {
      document.querySelectorAll(".slot").forEach(x => x.classList.remove("active"));
      b.classList.add("active");
      state.slot = slot;
      continueBtn.disabled = false;
    });

    slotsEl.appendChild(b);
  });

  debugEl.textContent =
    "Debug: staff=" + state.staff +
    " | date=" + state.date +
    " | slots=" + list.length +
    " | days(total)=" + (state.data?.days?.length || 0);
}

async function loadAvailability(){
  hideMsg();
  slotsEl.style.display = "none";
  loadingEl.style.display = "block";
  debugEl.textContent = "";

  try {
    const res = await fetch("/api/availability?days=14&duration=60&step=15", {
      cache: "no-store"
    });

    const text = await res.text();

    let data;
    try {
      data = JSON.parse(text);
    } catch {
      throw new Error(
        "API returned HTML instead of JSON. First chars: " +
        text.slice(0, 30)
      );
    }

    if (!res.ok || !data.ok) {
      throw new Error(data?.error || data?.detail || "API error");
    }

    state.data = data;
    tzLine.textContent = data.timeZone ? ("Timezone: " + data.timeZone) : "";

    renderDates();
    renderSlots();

    debugEl.textContent =
      "Debug: days=" + (data.days?.length || 0) +
      " | staff=ana/glenda | api OK";

  } catch (e) {
    loadingEl.style.display = "none";
    showMsg(
      "Error loading availability: <b>" + e.message + "</b>",
      "error"
    );
    debugEl.textContent = "Debug: fetch /api/availability failed.";
  }
}

/* EVENTS */
document.querySelectorAll(".staff-btn").forEach(btn => {
  btn.addEventListener("click", () => setStaff(btn.dataset.staff));
});

document.getElementById("reloadBtn").addEventListener("click", loadAvailability);

document.getElementById("backBtn").addEventListener("click", () => {
  window.location.href = "services2.html";
});

continueBtn.addEventListener("click", () => {
  if (!state.slot || !state.date) return;

  const staffName = state.staff === "ana" ? "Ana Paula" : "Glenda Garcia";
  const payload = {
    staffKey: state.staff,
    staffName,
    date: state.date,
    startISO: state.slot.startISO,
    endISO: state.slot.endISO,
    label: state.slot.label,
    durationMin: 60
  };

  localStorage.setItem(BOOKING_KEY, JSON.stringify(payload));
  window.location.href = "checkout.html";
});

/* INIT */
loadAvailability();
</script>
</body>
</html>
