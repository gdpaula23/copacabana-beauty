<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Booking | Copacabana Beauty</title>

<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">

<style>
:root{
  --verde:#3E4A2B;
  --bege:#F4EAD6;
  --bege-soft: rgba(244,234,214,.10);
  --bege-border: rgba(244,234,214,.18);
  --dark: rgba(0,0,0,.35);
}
*{margin:0;padding:0;box-sizing:border-box}

body{font-family:'Montserrat',sans-serif;color:var(--bege)}
.page-bg{
  min-height:100vh;display:flex;flex-direction:column;
  background:
    radial-gradient(circle at 20% 20%, rgba(244,234,214,.12), transparent 80%),
    linear-gradient(180deg,#3E4A2B,#3E4A2B);
}
.main{flex:1;display:flex;flex-direction:column;align-items:center}
.hero{padding:56px 20px 26px;text-align:center}
.hero img{max-width:240px}

.card{
  width:100%;max-width:860px;margin:0 18px 80px;padding:28px;
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)), var(--bege-soft);
  backdrop-filter: blur(16px);
  border-radius:22px;border:1px solid rgba(255,255,255,.15);
  box-shadow:0 40px 80px rgba(0,0,0,.35);
}
.card h1{
  font-family:'Cormorant Garamond',serif;
  font-size:38px;text-align:center;margin-bottom:10px;
}
.subtitle{text-align:center;opacity:.85;font-size:14px;line-height:1.6;margin-bottom:18px}
.divider{height:1px;background:linear-gradient(to right, transparent, rgba(244,234,214,.85), transparent);margin:16px 0 22px}

.grid{display:grid;grid-template-columns: 1fr 1.3fr;gap:18px}
.block{background:rgba(0,0,0,.18);border:1px solid var(--bege-border);border-radius:18px;padding:16px}
.label{font-size:12px;letter-spacing:2px;text-transform:uppercase;opacity:.85;margin-bottom:10px}

.staff{display:grid;gap:10px}
.staff-btn{
  display:flex;align-items:center;gap:12px;width:100%;
  border:none;cursor:pointer;padding:12px;border-radius:16px;
  background:rgba(0,0,0,.20);
  border:1px solid rgba(244,234,214,.18);
  color:var(--bege);transition:.2s;text-align:left;
}
.staff-btn:hover{transform:translateY(-1px); background:rgba(0,0,0,.26)}
.staff-btn.active{background:rgba(244,234,214,.12);border-color:rgba(244,234,214,.55)}
.staff-btn img{
  width:44px;height:44px;border-radius:50%;object-fit:cover;
  border:1px solid rgba(244,234,214,.35);background:rgba(0,0,0,.12);
}
.staff-name{font-weight:500;font-size:14px}
.staff-role{font-size:12px;opacity:.75;margin-top:2px}

.select{
  width:100%;padding:12px;border-radius:12px;
  border:1px solid rgba(244,234,214,.20);
  background:var(--dark);color:#fff;outline:none;
}

.slots{
  margin-top:14px;
  display:grid;
  grid-template-columns: repeat(4, minmax(92px, 1fr));
  gap:10px;
}
.slot{
  border:1px solid rgba(244,234,214,.20);
  background:rgba(0,0,0,.20);
  color:var(--bege);
  border-radius:14px;
  padding:10px 8px;
  cursor:pointer;
  transition:.18s;
  font-size:13px;
  text-align:center;
}
.slot:hover{transform:translateY(-1px); background:rgba(0,0,0,.26)}
.slot.active{background:rgba(244,234,214,.12);border-color:rgba(244,234,214,.65)}

.msg{margin-top:12px;font-size:13px;opacity:.9;line-height:1.6}
.msg.error{color:#ffd3d3;opacity:1}
.msg.ok{color:#d9ffd9}

.actions{
  display:flex;justify-content:space-between;align-items:center;
  gap:10px;flex-wrap:wrap;margin-top:18px;
}
.btn{
  border:none;border-radius:999px;padding:12px 18px;
  cursor:pointer;font-size:12px;letter-spacing:2px;
  text-transform:uppercase;transition:.18s;
}
.btn-ghost{background:transparent;color:var(--bege);border:1px solid rgba(244,234,214,.35)}
.btn-ghost:hover{background:rgba(244,234,214,.10)}
.btn-primary{background:var(--bege);color:var(--verde)}
.btn-primary:hover{transform:translateY(-1px)}
.btn[disabled]{opacity:.45;cursor:not-allowed;transform:none}

.footer{padding:40px 20px;text-align:center;font-size:12px;opacity:.6}

@media(max-width:900px){
  .card{padding:22px}
  .grid{grid-template-columns:1fr}
  .slots{grid-template-columns: repeat(3, minmax(92px, 1fr));}
}
@media(max-width:420px){
  .slots{grid-template-columns: repeat(2, minmax(92px, 1fr));}
  .hero img{max-width:210px}
}
</style>
</head>

<body>
<div class="page-bg">
  <main class="main">

    <section class="hero">
      <img src="eu1.png" alt="Copacabana Beauty">
    </section>

    <section class="card">
      <h1>Booking</h1>
      <div class="subtitle">
        Choose staff, then pick a date and time.<br>
        <span id="tzLine" style="opacity:.75;"></span>
      </div>

      <div class="divider"></div>

      <div class="grid">

        <div class="block">
          <div class="label">Select staff</div>

          <div class="staff">
            <button class="staff-btn active" type="button" data-staff="ana">
              <img src="ana.jpg" alt="Ana Paula">
              <div>
                <div class="staff-name">Ana Paula</div>
                <div class="staff-role">Therapist</div>
              </div>
            </button>

            <button class="staff-btn" type="button" data-staff="glenda">
              <img src="glenda.jpg" alt="Glenda Garcia">
              <div>
                <div class="staff-name">Glenda Garcia</div>
                <div class="staff-role">Therapist</div>
              </div>
            </button>
          </div>

          <div class="msg" style="margin-top:14px; opacity:.85;">
            Duration: <b>60 min</b> · Working hours: <b>09:00–18:00</b>
          </div>
        </div>

        <div class="block">
          <div class="label">Select date</div>

          <select id="dateSelect" class="select"></select>

          <div id="loading" class="msg">Loading availability...</div>
          <div id="message" class="msg" style="display:none;"></div>

          <div id="slots" class="slots" style="display:none;"></div>

          <div class="actions">
            <button class="btn btn-ghost" id="reloadBtn" type="button">Reload</button>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn btn-ghost" id="backBtn" type="button">Back</button>
              <button class="btn btn-primary" id="continueBtn" type="button" disabled>Continue</button>
            </div>
          </div>

          <div class="msg" id="debug" style="opacity:.55; font-size:11px; margin-top:12px;"></div>
        </div>

      </div>
    </section>

  </main>

  <footer class="footer">© 2026 Copacabana Beauty · Booking</footer>
</div>

<script>
const BOOKING_KEY = "cb_booking_v1";

const state = {
  staff: "ana",
  data: null,
  date: null,
  slot: null
};

const dateSelect = document.getElementById("dateSelect");
const slotsEl = document.getElementById("slots");
const loadingEl = document.getElementById("loading");
const msgEl = document.getElementById("message");
const debugEl = document.getElementById("debug");
const continueBtn = document.getElementById("continueBtn");
const tzLine = document.getElementById("tzLine");

function showMsg(text, type){
  msgEl.style.display = "block";
  msgEl.className = "msg " + (type || "");
  msgEl.innerHTML = text;
}
function hideMsg(){
  msgEl.style.display = "none";
  msgEl.innerHTML = "";
  msgEl.className = "msg";
}

function setStaff(staff){
  state.staff = staff;
  state.slot = null;
  continueBtn.disabled = true;

  document.querySelectorAll(".staff-btn").forEach(b => b.classList.remove("active"));
  const btn = document.querySelector(`.staff-btn[data-staff="${staff}"]`);
  if (btn) btn.classList.add("active");

  renderSlots();
}

/** ✅ ESTA FUNÇÃO EXISTE AQUI (resolve teu erro) */
function renderDates(){
  dateSelect.innerHTML = "";
  const days = state.data?.days || [];

  if (!days.length){
    loadingEl.style.display = "none";
    showMsg("No dates returned from API.", "error");
    slotsEl.style.display = "none";
    debugEl.textContent = "Debug: data.days empty.";
    return;
  }

  days.forEach(d => {
    const opt = document.createElement("option");
    opt.value = d.date;
    opt.textContent = d.date;
    dateSelect.appendChild(opt);
  });

  state.date = days[0].date;
  dateSelect.value = state.date;
}

function renderSlots(){
  hideMsg();
  slotsEl.innerHTML = "";
  state.slot = null;
  continueBtn.disabled = true;

  const days = state.data?.days || [];
  if (!days.length){
    slotsEl.style.display = "none";
    return;
  }

  if (!state.date) {
    state.date = days[0].date;
    dateSelect.value = state.date;
  }

  const dayObj = days.find(d => d.date === state.date);
  if (!dayObj){
    loadingEl.style.display = "none";
    showMsg("Select a date to see available times.", "");
    slotsEl.style.display = "none";
    return;
  }

  const list = dayObj[state.staff] || [];

  loadingEl.style.display = "none";
  slotsEl.style.display = "grid";

  if (!list.length){
    showMsg("No available times for this date. Try another day.", "");
    return;
  }

  list.forEach(slot => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "slot";
    b.textContent = slot.label;

    b.addEventListener("click", () => {
      document.querySelectorAll(".slot").forEach(x => x.classList.remove("active"));
      b.classList.add("active");
      state.slot = slot;
      continueBtn.disabled = false;
    });

    slotsEl.appendChild(b);
  });
}

async function loadAvailability(){
  hideMsg();
  slotsEl.style.display = "none";
  loadingEl.style.display = "block";
  debugEl.textContent = "";

  try{
    const res = await fetch("/api/availability?days=14&duration=60&step=15", { cache: "no-store" });

    const text = await res.text();
    if (!text.trim().startsWith("{")) {
      throw new Error("API returned HTML instead of JSON. First chars: " + text.slice(0, 40));
    }

    const data = JSON.parse(text);

    if (!res.ok || !data.ok){
      throw new Error(data?.error || data?.detail || "API error");
    }

    state.data = data;
    tzLine.textContent = data.timeZone ? ("Timezone: " + data.timeZone) : "";

    renderDates();
    renderSlots();

    debugEl.textContent = "Debug: ok | days=" + (data.days?.length || 0);
  }catch(e){
    loadingEl.style.display = "none";
    showMsg("Error loading availability: <b>" + (e.message || e) + "</b>", "error");
    debugEl.textContent = "Debug: fetch /api/availability failed or returned HTML.";
  }
}

/* EVENTS */
document.querySelectorAll(".staff-btn").forEach(btn => {
  btn.addEventListener("click", () => setStaff(btn.dataset.staff));
});

dateSelect.addEventListener("change", () => {
  state.date = dateSelect.value;
  renderSlots();
});

document.getElementById("reloadBtn").addEventListener("click", loadAvailability);

document.getElementById("backBtn").addEventListener("click", () => {
  window.location.href = "services2.html";
});

continueBtn.addEventListener("click", () => {
  if (!state.slot || !state.date) return;

  const staffName = state.staff === "ana" ? "Ana Paula" : "Glenda Garcia";
  const payload = {
    staffKey: state.staff,
    staffName,
    date: state.date,
    startISO: state.slot.startISO,
    endISO: state.slot.endISO,
    label: state.slot.label,
    durationMin: 60
  };

  localStorage.setItem(BOOKING_KEY, JSON.stringify(payload));
  window.location.href = "checkout.html";
});

/* INIT */
loadAvailability();
</script>

</body>
</html>
