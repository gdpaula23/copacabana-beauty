<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agendamento | Copacabana Beauty</title>

  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="theme.css">

  <style>
    :root{
      --olive-900:#2F3A22;
      --olive-800:#3F4D2F;
      --olive-700:#566643;

      --beige:#F4EAD6;
      --beige-14: rgba(244,234,214,.14);
      --beige-22: rgba(244,234,214,.22);
      --beige-40: rgba(244,234,214,.40);
    }

    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Montserrat',sans-serif;
      color:var(--beige);
      min-height:100vh;
    }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:90px 18px 80px;
    }

    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      margin-bottom:22px;
    }

    h1{
      font-family:'Cormorant Garamond',serif;
      font-weight:600;
      font-size:44px;
      letter-spacing:.2px;
    }

    .sub{
      opacity:.85;
      font-size:14px;
      margin-top:6px;
    }

    .card{
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)),
        rgba(244,234,214,.10);
      border:1px solid rgba(244,234,214,.25);
      border-radius:22px;
      backdrop-filter: blur(14px);
      box-shadow:0 30px 70px rgba(0,0,0,.25);
    }

    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:18px;
      align-items:stretch;
    }

    .left{ padding:18px; display:flex; flex-direction:column; }
    .right{ padding:18px; display:flex; flex-direction:column; min-height:420px; }

    .section-title{
      font-size:12px;
      letter-spacing:2px;
      opacity:.85;
      margin:10px 0 10px;
      text-transform:uppercase;
    }

    .staff-list{ display:grid; gap:12px; margin-top:2px; }

    .staff-btn{
      display:flex;
      align-items:center;
      justify-content:space-between;
      width:100%;
      padding:18px 18px;
      border-radius:18px;
      border:1px solid rgba(244,234,214,.22);
      background:rgba(0,0,0,.18);
      color:var(--beige);
      cursor:pointer;
      transition:.2s;
      text-align:left;
      min-height:92px;
    }
    .staff-btn:hover{transform:translateY(-1px); background:rgba(0,0,0,.24)}
    .staff-btn.active{
      border-color: rgba(244,234,214,.70);
      background: rgba(244,234,214,.14);
    }
    /* ✅ enquanto carrega, bloqueia clique e deixa visual claro */
    .staff-btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
    }

    .staff-left{ display:flex; align-items:center; gap:14px; min-width:0; }

    .avatar{
      width:64px;
      height:64px;
      border-radius:999px;
      flex:0 0 64px;
      object-fit:cover;
      object-position:center;
      display:block;
      border: 2px solid rgba(244,234,214,.75);
      box-shadow:0 14px 30px rgba(0,0,0,.28);
      background: rgba(0,0,0,.2);
    }

    .staff-meta{ display:flex; flex-direction:column; gap:3px; min-width:0; }
    .staff-name{
      font-weight:500;
      font-size:14px;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .staff-tag{
      font-size:12px;
      opacity:.82;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .staff-chevron{ opacity:.9; font-size:20px; padding-left:10px; }

    .hint{ opacity:.85; font-size:13px; line-height:1.6; margin-top:14px; }
    .error{ color:#ffd3d3; font-size:13px; opacity:.95; margin-top:14px; }
    .loading{ opacity:.9; font-size:14px; margin-top:10px; }

    .row{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }

    select{
      background:rgba(0,0,0,.22);
      color:var(--beige);
      border:1px solid rgba(244,234,214,.22);
      border-radius:14px;
      padding:9px 12px;
      outline:none;
      min-width:160px;
      font-size:13px;
      line-height:1;
    }

    .slots{
      display:grid;
      grid-template-columns: repeat(4, minmax(90px, 1fr));
      gap:10px;
      margin-top:14px;
    }

    .slot{
      padding:12px 10px;
      border-radius:14px;
      border:1px solid rgba(244,234,214,.22);
      background:rgba(0,0,0,.18);
      color:var(--beige);
      cursor:pointer;
      transition:.18s;
      text-align:center;
      font-size:14px;
    }
    .slot:hover{transform:translateY(-1px); background:rgba(0,0,0,.25)}
    .slot.active{
      border-color: rgba(244,234,214,.65);
      background: rgba(244,234,214,.12);
    }

    .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:auto;
      padding-top:16px;
      flex-wrap:wrap;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:12px 18px;
      cursor:pointer;
      font-size:12px;
      letter-spacing:2px;
      text-transform:uppercase;
      transition:.18s;
    }
    .btn-ghost{
      background:transparent;
      color:var(--beige);
      border:1px solid rgba(244,234,214,.35);
    }
    .btn-ghost:hover{background:rgba(244,234,214,.10)}
    .btn-primary{
      background:var(--beige);
      color:var(--olive-900);
    }
    .btn-primary:hover{transform:translateY(-1px)}

    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
      .slots{grid-template-columns: repeat(3, minmax(90px, 1fr));}
      h1{font-size:38px}
      select{min-width: 170px;}
    }
    @media (max-width: 420px){
      .slots{grid-template-columns: repeat(2, minmax(90px, 1fr));}
      .avatar{ width:56px;height:56px;flex:0 0 56px; }
      .staff-btn{min-height:86px;padding:16px 16px;}
      select{min-width: 150px;}
    }
  </style>
</head>
<body>

  <nav style="position:fixed;top:0;left:0;width:100%;padding:18px 40px;display:flex;justify-content:flex-end;z-index:10;background:transparent;">
    <a href="home.html" style="color:rgba(244,234,214,.9);text-decoration:none;font-size:12px;letter-spacing:2px;margin-left:22px;">HOME</a>
    <a href="services2.html" style="color:rgba(244,234,214,.9);text-decoration:none;font-size:12px;letter-spacing:2px;margin-left:22px;">SERVICES</a>
    <a href="cart.html" style="color:rgba(244,234,214,.9);text-decoration:none;font-size:12px;letter-spacing:2px;margin-left:22px;">BASKET</a>
  </nav>

  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Booking</h1>
        <div class="sub">Choose the professional and the best available time.</div>
      </div>
      <div class="sub" id="tzInfo"></div>
    </div>

    <div class="grid">
      <div class="card left">
        <div class="section-title">Select staff</div>

        <div class="staff-list">
          <button class="staff-btn" data-staff="ana" id="btnAna" type="button">
            <div class="staff-left">
              <img class="avatar" src="eu.jpg" alt="Ana Paula">
              <div class="staff-meta">
                <div class="staff-name">Ana Paula</div>
                <div class="staff-tag">Therapist</div>
              </div>
            </div>
            <div class="staff-chevron">›</div>
          </button>

          <button class="staff-btn" data-staff="glenda" id="btnGlenda" type="button">
            <div class="staff-left">
              <img class="avatar" src="glenda.jpg" alt="Glenda Garcia">
              <div class="staff-meta">
                <div class="staff-name">Glenda Garcia</div>
                <div class="staff-tag">Therapist</div>
              </div>
            </div>
            <div class="staff-chevron">›</div>
          </button>
        </div>

        <div class="hint" id="hintBox">
          Select a professional to see available dates and times.
        </div>

        <div class="error" id="errBox" style="display:none;"></div>
      </div>

      <div class="card right">
        <div class="row">
          <div class="section-title" style="margin:0;">Select date</div>
          <div class="date-select">
            <select id="dateSelect" disabled></select>
          </div>
        </div>

        <div id="loading" class="loading">Loading available times...</div>
        <div id="slots" class="slots" style="display:none;"></div>

        <div class="actions">
          <button class="btn btn-ghost" id="btnBack" type="button">Continue shopping</button>
          <button class="btn btn-primary" id="btnNext" disabled type="button">Continue</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const CART_BOOKING_KEY = "cb_booking_v1";

  // ✅ Reset ONLY when coming from checkout (Change therapist/time)
  const params = new URLSearchParams(location.search);
  if(params.get("reset") === "1"){
    sessionStorage.removeItem(CART_BOOKING_KEY);
    localStorage.removeItem(CART_BOOKING_KEY); // legado
  }

  // ===== Estado =====
  const state = {
    data: null,
    staff: null,
    date: null,
    slot: null,
  };

  const $ = (id) => document.getElementById(id);
  const errBox = $("errBox");
  const hintBox = $("hintBox");
  const slotsEl = $("slots");
  const loadingEl = $("loading");
  const dateSelect = $("dateSelect");
  const tzInfo = $("tzInfo");
  const btnNext = $("btnNext");

  function staffButtons(){
    return Array.from(document.querySelectorAll(".staff-btn"));
  }

  function showError(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function clearError(){
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  function setStaff(staff){
    state.staff = staff;
    state.slot = null;

    document.querySelectorAll(".staff-btn").forEach(b => b.classList.remove("active"));
    const btn = document.querySelector(`.staff-btn[data-staff="${staff}"]`);
    if (btn) btn.classList.add("active");

    hintBox.textContent = "Select a date and time.";

    // só habilita dateSelect se já tiver dados carregados
    dateSelect.disabled = !state.data?.days?.length;

    // se já tiver data carregada, seta a primeira
    if (state.data?.days?.length){
      state.date = state.data.days[0].date;
      dateSelect.value = state.date;
    } else {
      state.date = null;
      dateSelect.value = "";
    }

    renderSlots();
  }

  function setDate(date){
    state.date = date;
    state.slot = null;
    renderSlots();
  }

  function setSlot(slotObj){
    state.slot = slotObj;
    btnNext.disabled = false;

    document.querySelectorAll(".slot").forEach(s => s.classList.remove("active"));
    const active = document.querySelector(`.slot[data-start="${slotObj.startISO}"]`);
    if (active) active.classList.add("active");
  }

  function renderDates(){
    dateSelect.innerHTML = "";
    if (!state.data?.days?.length) return;

    state.data.days.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.date;
      opt.textContent = d.date;
      dateSelect.appendChild(opt);
    });

    // sem staff ainda
    dateSelect.disabled = true;
  }

  function renderSlots(){
    slotsEl.innerHTML = "";
    btnNext.disabled = true;

    if (!state.staff){
      loadingEl.style.display = "none";
      slotsEl.style.display = "none";
      return;
    }

    if (!state.data || !state.date){
      // se ainda não carregou, mantém loading
      loadingEl.style.display = state.data ? "none" : "block";
      slotsEl.style.display = "none";
      return;
    }

    const dayObj = state.data.days.find(d => d.date === state.date);
    if (!dayObj) return;

    const list = dayObj[state.staff] || [];

    loadingEl.style.display = "none";
    slotsEl.style.display = "grid";

    if (!list.length){
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.style.gridColumn = "1 / -1";
      empty.innerHTML = "No available time slots on this day. Please try another date.";
      slotsEl.appendChild(empty);
      return;
    }

    list.forEach(slot => {
      const b = document.createElement("button");
      b.className = "slot";
      b.type = "button";
      b.textContent = slot.label;
      b.dataset.start = slot.startISO;
      b.addEventListener("click", () => setSlot(slot));
      slotsEl.appendChild(b);
    });
  }

  async function loadAvailability(){
    clearError();
    loadingEl.style.display = "block";
    slotsEl.style.display = "none";

    // ✅ FIX PRINCIPAL: bloqueia staff durante load pra evitar "clicar antes"
    staffButtons().forEach(b => b.disabled = true);

    try{
      const res = await fetch("/api/availability");
      const data = await res.json();

      if (!data.ok){
        throw new Error(data.error || "Falha ao carregar agenda");
      }

      state.data = data;
      tzInfo.textContent = data.timeZone ? `Timezone: ${data.timeZone}` : "";

      renderDates();

      // ✅ libera staff agora que terminou de carregar
      staffButtons().forEach(b => b.disabled = false);

      // Se a pessoa já tinha escolhido staff (edge case), seta data agora
      if (state.staff && state.data?.days?.length){
        dateSelect.disabled = false;
        if (!state.date){
          state.date = state.data.days[0].date;
        }
        dateSelect.value = state.date;
        renderSlots();
      } else {
        loadingEl.style.display = "none";
      }

    }catch(e){
      showError("Erro ao buscar agenda: " + (e.message || e));
      loadingEl.style.display = "none";
      staffButtons().forEach(b => b.disabled = false);
    }
  }

  // ===== Eventos =====
  $("btnAna").addEventListener("click", () => setStaff("ana"));
  $("btnGlenda").addEventListener("click", () => setStaff("glenda"));
  dateSelect.addEventListener("change", () => setDate(dateSelect.value));

  $("btnBack").addEventListener("click", () => {
    sessionStorage.removeItem(CART_BOOKING_KEY);
    localStorage.removeItem(CART_BOOKING_KEY);
    window.location.href = "services2.html";
  });

  $("btnNext").addEventListener("click", () => {
    if (!state.slot || !state.staff) return;

    const staffName = state.staff === "ana" ? "Ana Paula" : "Glenda Garcia";

    const payload = {
      staffKey: state.staff,
      staffName,
      date: state.date,
      startISO: state.slot.startISO,
      endISO: state.slot.endISO,
      label: state.slot.label,
      durationMin: 60
    };

    sessionStorage.setItem(CART_BOOKING_KEY, JSON.stringify(payload));
    localStorage.removeItem(CART_BOOKING_KEY);

    window.location.href = "checkout.html";
  });

  loadAvailability();
</script>
</body>
</html>
