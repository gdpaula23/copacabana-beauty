<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Booking confirmed | Copacabana Beauty</title>

<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">

<style>
:root{
  --olive-800:#3F4D2F;
  --beige:#F4EAD6;
  --radius-xl: 24px;
  --max: 860px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Montserrat',sans-serif;
  color:var(--beige);
  background:
    radial-gradient(circle at 12% 18%, rgba(244,234,214,.10), transparent 65%),
    radial-gradient(circle at 78% 12%, rgba(244,234,214,.08), transparent 68%),
    radial-gradient(circle at 55% 78%, rgba(244,234,214,.07), transparent 72%),
    linear-gradient(180deg,#4B5A3A 0%, #3F4D2F 45%, #2F3A22 100%);
  padding:120px 16px 90px;
}
.card{
  max-width:var(--max);
  margin:0 auto;
  border-radius:var(--radius-xl);
  border:1px solid rgba(244,234,214,.18);
  background:rgba(244,234,214,.08);
  padding:26px;
  text-align:center;
  box-shadow:0 26px 60px rgba(0,0,0,.16);
}
h1{
  font-family:'Cormorant Garamond',serif;
  font-size:42px;
  margin-bottom:8px;
}
p{opacity:.88; line-height:1.8;}
.kv{
  margin:18px auto 0;
  max-width:520px;
  text-align:left;
  padding:16px;
  border-radius:18px;
  border:1px solid rgba(244,234,214,.18);
  background:rgba(0,0,0,.10);
}
.row{
  display:flex;
  justify-content:space-between;
  gap:12px;
  padding:10px 6px;
  border-bottom:1px solid rgba(244,234,214,.12);
  font-size:14px;
}
.row:last-child{border-bottom:none}
.label{opacity:.75}
.value{font-weight:500}
.btnrow{
  display:flex;
  justify-content:center;
  gap:12px;
  flex-wrap:wrap;
  margin-top:18px;
}
.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:14px 18px;
  border-radius:999px;
  text-decoration:none;
  font-size:12px;
  letter-spacing:2px;
  text-transform:uppercase;
  transition:transform .2s ease, filter .2s ease;
  background:var(--beige);
  color:var(--olive-800);
  border:1px solid rgba(244,234,214,.75);
}
.btn.secondary{
  background:transparent;
  color:var(--beige);
  border:1px solid rgba(244,234,214,.35);
}
.btn:hover{transform:translateY(-2px); filter:brightness(.98);}
.small{margin-top:12px;font-size:12px;opacity:.78;line-height:1.7}
</style>
</head>

<body>
  <div class="card">
    <h1 id="title">Checking payment…</h1>
    <p id="subtitle">Please wait a moment.</p>

    <div class="kv" id="details" style="display:none;">
      <div class="row"><span class="label">Staff</span><span class="value" id="staff">—</span></div>
      <div class="row"><span class="label">Date</span><span class="value" id="date">—</span></div>
      <div class="row"><span class="label">Time</span><span class="value" id="time">—</span></div>
      <div class="row"><span class="label">Duration</span><span class="value" id="duration">—</span></div>
    </div>

    <div class="btnrow">
      <a class="btn secondary" href="/booking.html">Make another booking</a>
      <a id="waBtn" class="btn" href="#" target="_blank" rel="noopener" style="display:none;">Contact on WhatsApp</a>
    </div>

    <div class="small" id="hint">If you need help, you can contact us on WhatsApp.</div>
  </div>

<script>
  const BOOKING_KEY = "cb_booking_v1";
  const WHATSAPP_NUMBER = "447934424780";

  const el = {
    title: document.getElementById("title"),
    subtitle: document.getElementById("subtitle"),
    details: document.getElementById("details"),
    staff: document.getElementById("staff"),
    date: document.getElementById("date"),
    time: document.getElementById("time"),
    duration: document.getElementById("duration"),
    waBtn: document.getElementById("waBtn"),
    hint: document.getElementById("hint"),
  };

  function loadBooking() {
    try { return JSON.parse(localStorage.getItem(BOOKING_KEY) || "null"); }
    catch { return null; }
  }

  function formatDate(yyyyMmDd){
    return yyyyMmDd || "—";
  }

  function formatTimeLabel(label, startISO){
    if (label) return label;
    if (!startISO) return "—";
    try{
      const d = new Date(startISO);
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    } catch {
      return "—";
    }
  }

  function showDetails(data){
    el.details.style.display = "block";
    el.staff.textContent = data.staffName || data.staffKey || "—";
    el.date.textContent = formatDate(data.date);
    el.time.textContent = formatTimeLabel(data.label, data.startISO);
    el.duration.textContent = data.durationMin ? `${data.durationMin} min` : "—";
  }

  function showWhatsApp(data){
    const msg = data
      ? `Hello! My deposit is paid. Booking: ${data.staffName || data.staffKey} on ${data.date} at ${formatTimeLabel(data.label, data.startISO)}.`
      : `Hello! I’ve paid the deposit and need help with my booking.`;

    const waUrl = `https://api.whatsapp.com/send/?phone=${WHATSAPP_NUMBER}&text=${encodeURIComponent(msg)}&type=phone_number&app_absent=0`;
    el.waBtn.href = waUrl;
    el.waBtn.style.display = "inline-flex";
  }

  async function init(){
    const bookingLS = loadBooking();

    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get("session_id");

    // fallback imediato (se não tiver session_id)
    if (!sessionId){
      el.title.textContent = "Booking received";
      el.subtitle.textContent = "Thank you — your deposit payment was received. We’ll confirm your booking shortly.";
      if (bookingLS) showDetails(bookingLS);
      showWhatsApp(bookingLS);
      return;
    }

    try {
      const resp = await fetch(`/api/get-session?session_id=${encodeURIComponent(sessionId)}`);
      const data = await resp.json();

      if (!resp.ok || !data?.ok){
        throw new Error(data?.error || "Failed to verify payment");
      }

      const md = data.metadata || {};
      // usa Stripe metadata como fonte principal
      const booking = {
        staffKey: md.staffKey || bookingLS?.staffKey,
        staffName: md.staffName || bookingLS?.staffName,
        date: md.date || bookingLS?.date,
        label: md.label || bookingLS?.label,
        startISO: md.startISO || bookingLS?.startISO,
        endISO: md.endISO || bookingLS?.endISO,
        durationMin: md.durationMin || bookingLS?.durationMin,
      };

      if (data.payment_status === "paid") {
        el.title.textContent = "Booking confirmed ✅";
        el.subtitle.textContent = "Thank you — your deposit payment was received and your appointment is confirmed.";
      } else {
        el.title.textContent = "Payment not confirmed";
        el.subtitle.textContent = "We couldn’t confirm your payment yet. If you already paid, please wait a moment and refresh.";
      }

      showDetails(booking);
      showWhatsApp(booking);

    } catch (e){
      console.error(e);
      // fallback com localStorage
      el.title.textContent = "Booking received";
      el.subtitle.textContent = "Thank you — your deposit payment was received. We’ll confirm your booking shortly.";
      if (bookingLS) showDetails(bookingLS);
      showWhatsApp(bookingLS);
    }
  }

  init();
</script>
</body>
</html>
